name: Test Suite

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        - cron: '0 2 * * 1' # Weekly on Monday at 2 AM

jobs:
    test:
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                node-version: ['18', '20']

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run smoke tests
              run: npm run test:smoke
              if: matrix.os == 'ubuntu-latest'

            - name: Run unit tests
              run: npm run test:unit

            - name: Run integration tests
              run: npm run test:integration
              if: matrix.os == 'ubuntu-latest'

            - name: Run performance tests
              run: npm run test:performance
              if: matrix.os == 'ubuntu-latest'

            - name: Run end-to-end tests
              run: npm run test:e2e
              if: matrix.os == 'ubuntu-latest'

            - name: Run all tests with coverage
              run: npm run test:coverage
              if: matrix.os == 'ubuntu-latest'

            - name: Upload coverage reports
              uses: codecov/codecov-action@v3
              if: matrix.os == 'ubuntu-latest'
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella

    build-test:
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 'lts/*'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run package

            - name: Test build artifacts
              run: |
                  if [ -d "out" ]; then
                      echo "Build artifacts created successfully"
                      ls -la out/
                  else
                      echo "No build artifacts found"
                      exit 1
                  fi
